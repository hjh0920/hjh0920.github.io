<!DOCTYPE html>


<html lang="en">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>axi_quad_spi |  Welcome</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
        <style>
            .outer {
                margin-left: 15%;
            }
        </style>
      <section class="outer">
  <article
  id="post-axi_quad_spi"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  axi_quad_spi
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/07/08/axi_quad_spi/" class="article-date">
  <time datetime="2023-07-08T03:42:54.000Z" itemprop="datePublished">2023-07-08</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Xilinx-IP/">Xilinx IP</a>
  </div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="系统框图"><a href="#系统框图" class="headerlink" title="系统框图"></a>系统框图</h2><h3 id="正常模式"><a href="#正常模式" class="headerlink" title="正常模式"></a>正常模式</h3><p><img src="/MD_IMG/axi_quad_spi.assets/image-20230603224844537.png" alt="image-20230603224844537"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230603230735125.png" alt="image-20230603230735125"></p>
<h3 id="XIP模式"><a href="#XIP模式" class="headerlink" title="XIP模式"></a>XIP模式</h3><p><img src="/MD_IMG/axi_quad_spi.assets/image-20230603234947885.png" alt="image-20230603234947885"></p>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604162323509.png" alt="image-20230604162323509"></p>
<h2 id="IP-核配置"><a href="#IP-核配置" class="headerlink" title="IP 核配置"></a>IP 核配置</h2><p><img src="/MD_IMG/axi_quad_spi.assets/image-20230603235750254.png" alt="image-20230603235750254"></p>
<h3 id="AXI-Interface-Option"><a href="#AXI-Interface-Option" class="headerlink" title="AXI Interface Option"></a>AXI Interface Option</h3><h4 id="XIP-Mode"><a href="#XIP-Mode" class="headerlink" title="XIP Mode"></a>XIP Mode</h4><p>XIP全称：eXecute In Place（片内执行），只用于读操作。针对外设如果想进行读操作的时候，一般都是通过访问数据寄存器，而XIP则是直接以内存的形式访问。</p>
<hr>
<p><strong>为什么有XIP模式</strong></p>
<p>从软件的角度来看，SPI一般是连着flash来使用，flash作为一种存储模块，软件更加期望用memory的形式访问，在SoC上经常会有从flash里面搬运数据的需求。</p>
<hr>
<p><strong>XIP性能</strong></p>
<p>一般来说，non-xip模式下，由于可以通过寄存器配置来实现给出一个地址得到一大段的数据的操作，只要配置得当，数据读取的速率是会比xip模式下快的。</p>
<p>但是不同公司的SPI controller的寄存器配置肯定是不同的，完全使用寄存器配置的形式进行读取操作对于软件迁移的成本会比较大。</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604000449433.png" alt="image-20230604000449433"></p>
<h4 id="Performance-Mode"><a href="#Performance-Mode" class="headerlink" title="Performance Mode"></a>Performance Mode</h4><p>高性能模式将使用 AXI4 代替 AXI4-Lite 接⼝，并且在内核的发送和接收 FIFO 地址处可以使用突发功能。</p>
<h3 id="SPI-Options"><a href="#SPI-Options" class="headerlink" title="SPI Options"></a>SPI Options</h3><h4 id="Mode"><a href="#Mode" class="headerlink" title="Mode"></a>Mode</h4><p>模式有standard，dual，quad可选，standard和dual&#x2F;quad模式间有部分功能不能兼容，具体可以看下面寄存器映射中。</p>
<h4 id="Transaction-Width"><a href="#Transaction-Width" class="headerlink" title="Transaction Width"></a>Transaction Width</h4><p>设置传输事务的数据宽度：</p>
<ul>
<li><p>如果设置为8，即每次数据传输宽度为8-bit，一次数据传输需要8个SCK时钟</p>
</li>
<li><p>如果设置为16，即每次数据传输宽度为16-bit，一次数据传输需要16个SCK时钟</p>
</li>
</ul>
<h4 id="Frequency-Ratio"><a href="#Frequency-Ratio" class="headerlink" title="Frequency Ratio"></a>Frequency Ratio</h4><p>频率比是由两个数的乘积。输出的SPI时钟（sck）满足：</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604000811474.png" alt="image-20230604000811474"></p>
<h4 id="Slave-Device"><a href="#Slave-Device" class="headerlink" title="Slave Device"></a>Slave Device</h4><p>设备类型是混合的，支持winbond，micron，spansion，macronix共有的命令。如果勾选Micron，只能支持micron的命令，发送不支持的命令，IPISR状态寄存器就会报command error.</p>
<h4 id="Enable-Master-Mode"><a href="#Enable-Master-Mode" class="headerlink" title="Enable Master Mode"></a>Enable Master Mode</h4><p>这个选项决定SPI设备的主从模式，也可以在配置寄存器60h中修改</p>
<h4 id="Enable-STARTUP-Primitive"><a href="#Enable-STARTUP-Primitive" class="headerlink" title="Enable STARTUP Primitive"></a>Enable STARTUP Primitive</h4><p>STARTUP原语勾选上后指SPI的clk就会从FPGA专用的CCLK引脚输出时钟</p>
<h2 id="寄存器映射"><a href="#寄存器映射" class="headerlink" title="寄存器映射"></a>寄存器映射</h2><p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604001550143.png" alt="image-20230604001550143"></p>
<h3 id="0x40-SRR-软件复位"><a href="#0x40-SRR-软件复位" class="headerlink" title="0x40 (SRR) 软件复位"></a>0x40 (SRR) 软件复位</h3><p>将0x0000_000a的值写⼊软件复位寄存器，会将内核寄存器复位四个 AXI 时钟周期。任何其他写访问都会⽣成未定义的结果并导致错误。</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604002806486.png" alt="image-20230604002806486"></p>
<h3 id="0x60-SPICR-SPI控制"><a href="#0x60-SPICR-SPI控制" class="headerlink" title="0x60 (SPICR) SPI控制"></a>0x60 (SPICR) SPI控制</h3><p>SPI控制寄存器有着配置SPI时序工作方式（CPHA，CPOL），设置SPI设备主从状态，对数据寄存器进行复位等重要功能。需要注意：</p>
<ul>
<li>LSB 优先仅在标准 SPI 模式下支持。 Dual&#x2F;quad SPI 模式仅⽀持 MSB 优先模式</li>
<li>Dual&#x2F;quad SPI 模式仅⽀持 CPHA-CPOL 值为 00 或 11。</li>
<li>环回模式仅在标准 SPI 模式下支持。</li>
</ul>
<p>通常作为配置端，我们需要把SPI设置为主设备（SPICR【2】&#x3D;1），在测试工作状态时，可以设置环回模式（SPICR【0】&#x3D;1）</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604003253814.png" alt="image-20230604003253814"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604003204304.png" alt="image-20230604003204304"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604003227262.png" alt="image-20230604003227262"></p>
<h3 id="0x64-SPISR-SPI状态"><a href="#0x64-SPISR-SPI状态" class="headerlink" title="0x64 (SPISR) SPI状态"></a>0x64 (SPISR) SPI状态</h3><p>SPI状态寄存器是<strong>只读寄存器</strong>，通常用来：</p>
<ul>
<li>读取各种错误信息，即SPI控制寄存器中的配置错误（注意事项）。</li>
<li>从模式配置成功检查</li>
<li>数据FIFO的空满状态检查</li>
</ul>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604003644444.png" alt="image-20230604003644444"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604003921784.png" alt="image-20230604003921784"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604003823390.png" alt="image-20230604003823390"></p>
<h3 id="0x68-SPI-DTR-发送数据"><a href="#0x68-SPI-DTR-发送数据" class="headerlink" title="0x68 (SPI DTR) 发送数据"></a>0x68 (SPI DTR) 发送数据</h3><p>SPI 数据发送寄存器 (SPI DTR) 写⼊要在 SPI 总线上发送的数据。数据从 SPI DTR 传输到移位寄存器发送条件：</p>
<ul>
<li>在主模式下将 SPE （SPI控制寄存器）设置为 1</li>
<li>在从模式下， spisel 处于活动状态</li>
</ul>
<p>需要注意：</p>
<ul>
<li>SPI DTR 在填充前应处于复位状态，以便 DTR FIFO 写指针指向第 0 个位置。</li>
<li>如果尝试在已满的寄存器或 FIFO 上进写⼊，则 AXI 写⼊事务以错误条件完成。</li>
</ul>
<p>即在发送数据前，需要先在控制寄存器中对TX FIFO进行复位。</p>
<p><strong>在Dual&#x2F;quad SPI 模式</strong>：</p>
<ul>
<li>第⼀次写⼊必须始终是来⾃ AXI 事务的 SPI 命令，然后是地址（24 位或 32 位），然后填充要传输的数据。</li>
<li>在读取内存的状态寄存器时，根据命令要求，该寄存器应填充虚拟字节以及命令和地址（可选）。</li>
</ul>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604003956744.png" alt="image-20230604003956744"></p>
<h3 id="0x6c-SPI-DRR-接收数据"><a href="#0x6c-SPI-DRR-接收数据" class="headerlink" title="0x6c (SPI DRR) 接收数据"></a>0x6c (SPI DRR) 接收数据</h3><p>SPI 数据接收寄存器 (SPI DRR) ⽤于读取从 SPI 总线接收的数据。这是⼀个双缓冲寄存器。每次完成传输后，接收到的数据都存放在该寄存器中。</p>
<p>SPI 架构没有为从设备提供任何⼿段来限制总线上的流量。因此，对于从设备来说，只有在上次 SPI 传输之前读取 SPI DRR ，SPI DRR 才会在每个完成的事务之后更新。</p>
<p>需要注意：</p>
<ul>
<li>如果 SPI DRR 未读取且已满，则最近传输的数据将丢失并发⽣接收溢出中断。</li>
<li>如果试图读取⼀个空的接收寄存器或 FIFO，它会在状态寄存器中给出⼀个错误。</li>
<li>SPI DRR 的上电复位值未知。</li>
</ul>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004021970.png" alt="image-20230604004021970"></p>
<h3 id="0x70-SPISSR-从机选择"><a href="#0x70-SPISSR-从机选择" class="headerlink" title="0x70 (SPISSR) 从机选择"></a>0x70 (SPISSR) 从机选择</h3><p>选择slave个数，有几个slave就拉低几位，最多32个slave</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004043039.png" alt="image-20230604004043039"></p>
<h3 id="0x74-发送FIFO待发送数据量"><a href="#0x74-发送FIFO待发送数据量" class="headerlink" title="0x74 发送FIFO待发送数据量"></a>0x74 发送FIFO待发送数据量</h3><p>仅当 AXI Quad SPI 内核配置有 FIFO （FIFO 深度&#x3D; 16 或 256）时，SPI 发送 FIFO 占⽤寄存器 (TX_FIFO_OCY) 才存在，并且是只读寄存器。</p>
<p>主要用来查看发送FIFO中有多少个数据，比如读出是5，那么FIFO中还有6个数据待发送</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004059549.png" alt="image-20230604004059549"></p>
<h3 id="0x78-接收FIFO可读取数据量"><a href="#0x78-接收FIFO可读取数据量" class="headerlink" title="0x78 接收FIFO可读取数据量"></a>0x78 接收FIFO可读取数据量</h3><p>仅当 AXI Quad SPI 内核配置有 FIFO （FIFO 深度&#x3D; 16 或 256）时，SPI 接收 FIFO 占⽤寄存器 (RX_FIFO_OCY) 才存在。</p>
<p>主要用来查看接收FIFO中有多少个数据，比如读出是5，那么FIFO中还有6个数据还没接收走。</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004116322.png" alt="image-20230604004116322"></p>
<h3 id="0x1C-DGIER-全局中断使能"><a href="#0x1C-DGIER-全局中断使能" class="headerlink" title="0x1C (DGIER) 全局中断使能"></a>0x1C (DGIER) 全局中断使能</h3><p>使能了全局中断之后才能使用各种中断功能。</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004133556.png" alt="image-20230604004133556"></p>
<h3 id="0x20-IPISR-中断状态"><a href="#0x20-IPISR-中断状态" class="headerlink" title="0x20 (IPISR) 中断状态"></a>0x20 (IPISR) 中断状态</h3><p>由于中断端口只有一个，当中断发送时需要查询中断状态寄存器来判断是什么中断情况，具体使用什么中断功能由中断使能寄存器控制。</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004157069.png" alt="image-20230604004157069"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004227902.png" alt="image-20230604004227902"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004249905.png" alt="image-20230604004249905"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004307595.png" alt="image-20230604004307595"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004319017.png" alt="image-20230604004319017"></p>
<h3 id="0x28-IPIER-中断使能"><a href="#0x28-IPIER-中断使能" class="headerlink" title="0x28 (IPIER) 中断使能"></a>0x28 (IPIER) 中断使能</h3><p>主要是配置中断功能，由于中断功能是复用中断端口，因此需要选择合理的功能来减少控制复杂度</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004347277.png" alt="image-20230604004347277"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004425794.png" alt="image-20230604004425794"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004439199.png" alt="image-20230604004439199"></p>
<h3 id="XIP-模式"><a href="#XIP-模式" class="headerlink" title="XIP 模式"></a>XIP 模式</h3><p>在XIP模式，配置寄存器60h和64h变更，并且中断无法使用。</p>
<p>XIP模式适⽤于开机操作。在这种模式下，内核仅⽀持 INCR 和 WRAP 读取事务。</p>
<p>内核将 SPI 视为只读存储器。三个读取命令随读取 SPI 闪存时使⽤的配置模式提供。通过为 AXI4-Lite 和 AXI4 接⼝分配相同的频率来验证核⼼功能。内核内置的三个主要读取命令是快速读取 (0x0Bh)、DIOFR (0xBBh) 和 QIOFR (0xEBh)。</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604004542320.png" alt="image-20230604004542320"></p>
<h2 id="支持指令"><a href="#支持指令" class="headerlink" title="支持指令"></a>支持指令</h2><h3 id="通用指令"><a href="#通用指令" class="headerlink" title="通用指令"></a>通用指令</h3><p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604163057685.png" alt="image-20230604163057685"></p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604163103808.png" alt="image-20230604163103808"></p>
<h3 id="其他指令"><a href="#其他指令" class="headerlink" title="其他指令"></a>其他指令</h3><p>详见 <strong>PG153 AXI Quad SPI <strong>的</strong>Table 3-3</strong></p>
<h2 id="操作流程"><a href="#操作流程" class="headerlink" title="操作流程"></a>操作流程</h2><h3 id="写操作"><a href="#写操作" class="headerlink" title="写操作"></a>写操作</h3><p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604164316567.png" alt="image-20230604164316567"></p>
<h3 id="读操作"><a href="#读操作" class="headerlink" title="读操作"></a>读操作</h3><p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604164327376.png" alt="image-20230604164327376"></p>
<h2 id="Flash控制"><a href="#Flash控制" class="headerlink" title="Flash控制"></a>Flash控制</h2><h3 id="读ID"><a href="#读ID" class="headerlink" title="读ID"></a>读ID</h3><p>读ID指令为9F，读几个数据就写几个dummy数据，读fifo的第一个数据是FF，因为写指令占用了，第二个数据开始才是想要的数据。</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">proc</span><span class="title"> RDID</span> &#123;byte_num&#125; &#123;</span><br><span class="line"><span class="comment">    # 软件复位</span></span><br><span class="line">    WriteReg <span class="number">0x40</span> <span class="number">0xa</span></span><br><span class="line"><span class="comment">    # 中断使能</span></span><br><span class="line">    WriteReg <span class="number">0x28</span> <span class="number">0x3fff</span></span><br><span class="line"><span class="comment">    # 全局中断使能</span></span><br><span class="line">    WriteReg <span class="number">0x1c</span> <span class="number">0x80000000</span></span><br><span class="line"><span class="comment">    # 复位 tx rx fifo</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x1e6</span></span><br><span class="line"><span class="comment">    # 释放 fifo 复位</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"><span class="comment">    # CMD = 9F, 读 FLASH ID</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="number">0x9f</span></span><br><span class="line"><span class="comment">    # 要读多少个数据就写几个 dummy 数据</span></span><br><span class="line">    <span class="keyword">set</span> num <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> &#123;<span class="variable">$num</span> &lt; <span class="variable">$byte_num</span>&#125; &#123;</span><br><span class="line">        WriteReg <span class="number">0x68</span> <span class="number">0x00</span></span><br><span class="line">        <span class="keyword">incr</span> num <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">    # 选择 0 通道CS</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x00</span></span><br><span class="line"><span class="comment">    # 使能 master, 开始发数据</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x86</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS 拉高</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x1</span></span><br><span class="line"><span class="comment">    # 禁用 master</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span> num <span class="number">0</span></span><br><span class="line">    <span class="keyword">set</span> id_data <span class="string">&quot;RDID is &quot;</span></span><br><span class="line">    <span class="keyword">while</span> &#123;<span class="variable">$num</span> &lt; <span class="variable">$byte_num</span> + <span class="number">1</span>&#125; &#123;</span><br><span class="line">        <span class="keyword">if</span> &#123;<span class="variable">$num</span> &gt;= <span class="number">1</span>&#125; &#123;</span><br><span class="line">            <span class="keyword">append</span> id_data [<span class="keyword">string</span> range [ReadReg <span class="number">0x6c</span>] end<span class="number">-1</span> end]</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            ReadReg <span class="number">0x6c</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">incr</span> num <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$id_data</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="写使能"><a href="#写使能" class="headerlink" title="写使能"></a>写使能</h3><p>每次进行擦除或者写操作之前都要先开启写使能，否则不生效。</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">proc</span><span class="title"> WREN</span> &#123;&#125; &#123;</span><br><span class="line"><span class="comment">    # 复位 tx rx fifo</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x1e6</span></span><br><span class="line"><span class="comment">    # 释放 fifo 复位</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"><span class="comment">    # CMD = 06, 写使能</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="number">0x06</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x00</span></span><br><span class="line"><span class="comment">    # 使能 master, 开始发数据</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x86</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS 拉高</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x1</span></span><br><span class="line"><span class="comment">    # 禁用 master</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Write Enable!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="扇区擦除"><a href="#扇区擦除" class="headerlink" title="扇区擦除"></a>扇区擦除</h3><p>先发送写使能指令，再发送扇区擦除指令</p>
<hr>
<p>对于 N25Q128 FLASH</p>
<p><img src="/MD_IMG/axi_quad_spi.assets/image-20230604212044485.png" alt="image-20230604212044485"></p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">proc</span><span class="title"> SE</span> &#123;Sector_Num&#125; &#123;</span><br><span class="line">    WREN</span><br><span class="line"><span class="comment">    # 复位 tx rx fifo</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x1e6</span></span><br><span class="line"><span class="comment">    # 释放 fifo 复位</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"><span class="comment">    # CMD = d8, 扇区擦除</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="number">0xd8</span></span><br><span class="line"><span class="comment">    # Write Address</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="variable">$Sector_Num</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="number">0x00</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="number">0x00</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x00</span></span><br><span class="line"><span class="comment">    # 使能 master, 开始发数据</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x86</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS 拉高</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x1</span></span><br><span class="line"><span class="comment">    # 禁用 master</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Sector Erase Done!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="整片擦除"><a href="#整片擦除" class="headerlink" title="整片擦除"></a>整片擦除</h3><p>先发送写使能指令，再发送整片擦除指令</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">proc</span><span class="title"> BE</span> &#123;&#125; &#123;</span><br><span class="line">    WREN</span><br><span class="line"><span class="comment">    # 复位 tx rx fifo</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x1e6</span></span><br><span class="line"><span class="comment">    # 释放 fifo 复位</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"><span class="comment">    # CMD = c7, 整片擦除</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="number">0xc7</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x00</span></span><br><span class="line"><span class="comment">    # 使能 master, 开始发数据</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x86</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS 拉高</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x1</span></span><br><span class="line"><span class="comment">    # 禁用 master</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Bulk Erase Done!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="页写"><a href="#页写" class="headerlink" title="页写"></a>页写</h3><p>先写前 128 Byte, 因为FIFO深度256, 但是cmd+地址占用4Byte, 所以实际使用不足256Byte可用</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">proc</span><span class="title"> PP</span> &#123;address&#125; &#123;</span><br><span class="line">    WREN</span><br><span class="line"><span class="comment"># 先写前 128 Byte, 因为FIFO深度256, 但是cmd+地址占用4Byte, 所以实际使用不足256Byte可用</span></span><br><span class="line"><span class="comment">    # 复位 tx rx fifo</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x1e6</span></span><br><span class="line"><span class="comment">    # 释放 fifo 复位</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"><span class="comment">    # CMD = 02, 页写</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="number">0x02</span></span><br><span class="line"><span class="comment">    # Write Address</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> [<span class="keyword">expr</span> (<span class="variable">$address</span> &gt;&gt; <span class="number">16</span>)]</span><br><span class="line">    WriteReg <span class="number">0x68</span> [<span class="keyword">expr</span> (<span class="variable">$address</span> % (<span class="number">2</span>**<span class="number">16</span>)) &gt;&gt; <span class="number">8</span>]</span><br><span class="line">    WriteReg <span class="number">0x68</span> [<span class="keyword">expr</span> (<span class="variable">$address</span> % (<span class="number">2</span>**<span class="number">8</span>))]</span><br><span class="line"><span class="comment">    # Write Data</span></span><br><span class="line">    <span class="keyword">set</span> num <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> &#123;<span class="variable">$num</span> &lt; <span class="number">128</span>&#125; &#123;</span><br><span class="line">        WriteReg <span class="number">0x68</span> <span class="variable">$num</span></span><br><span class="line">        <span class="keyword">incr</span> num <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">    # 选择 0 通道CS</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x00</span></span><br><span class="line"><span class="comment">    # 使能 master, 开始发数据</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x86</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS 拉高</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x1</span></span><br><span class="line"><span class="comment">    # 禁用 master</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"><span class="comment"># 再写后 128 Byte</span></span><br><span class="line"><span class="comment">    # 每次写操作之前需要重新开启写使能</span></span><br><span class="line">    WREN</span><br><span class="line">    <span class="keyword">set</span> address [<span class="keyword">expr</span> &#123;<span class="variable">$address</span> + <span class="number">128</span>&#125;]</span><br><span class="line">    <span class="keyword">puts</span> [ <span class="keyword">format</span> <span class="number">0</span>x%<span class="number">08</span>x <span class="variable">$address</span>]</span><br><span class="line"><span class="comment">    # 复位 tx rx fifo</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x1e6</span></span><br><span class="line"><span class="comment">    # 释放 fifo 复位</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"><span class="comment">    # CMD = 02, 页写</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="number">0x02</span></span><br><span class="line"><span class="comment">    # Write Address</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> [<span class="keyword">expr</span> (<span class="variable">$address</span> &gt;&gt; <span class="number">16</span>)]</span><br><span class="line">    WriteReg <span class="number">0x68</span> [<span class="keyword">expr</span> (<span class="variable">$address</span> % (<span class="number">2</span>**<span class="number">16</span>)) &gt;&gt; <span class="number">8</span>]</span><br><span class="line">    WriteReg <span class="number">0x68</span> [<span class="keyword">expr</span> (<span class="variable">$address</span> % (<span class="number">2</span>**<span class="number">8</span>))]</span><br><span class="line"><span class="comment">    # Write Data</span></span><br><span class="line">    <span class="keyword">while</span> &#123;<span class="variable">$num</span> &lt; <span class="number">256</span>&#125; &#123;</span><br><span class="line">        WriteReg <span class="number">0x68</span> <span class="variable">$num</span></span><br><span class="line">        <span class="keyword">incr</span> num <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">    # 选择 0 通道CS</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x00</span></span><br><span class="line"><span class="comment">    # 使能 master, 开始发数据</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x86</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS 拉高</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x1</span></span><br><span class="line"><span class="comment">    # 禁用 master</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Page Program Done!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="字节读"><a href="#字节读" class="headerlink" title="字节读"></a>字节读</h3><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">proc</span><span class="title"> READ</span> &#123;address number&#125; &#123;</span><br><span class="line"><span class="comment">    # 复位 tx rx fifo</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x1e6</span></span><br><span class="line"><span class="comment">    # 释放 fifo 复位</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"><span class="comment">    # CMD = 03, 按字节读数据</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> <span class="number">0x03</span></span><br><span class="line"><span class="comment">    # Read Address</span></span><br><span class="line">    WriteReg <span class="number">0x68</span> [<span class="keyword">expr</span> (<span class="variable">$address</span> &gt;&gt; <span class="number">16</span>)]</span><br><span class="line">    WriteReg <span class="number">0x68</span> [<span class="keyword">expr</span> (<span class="variable">$address</span> % (<span class="number">2</span>**<span class="number">16</span>)) &gt;&gt; <span class="number">8</span>]</span><br><span class="line">    WriteReg <span class="number">0x68</span> [<span class="keyword">expr</span> (<span class="variable">$address</span> % (<span class="number">2</span>**<span class="number">8</span>))]</span><br><span class="line"><span class="comment">    # 要读多少个数据就写几个 dummy 数据</span></span><br><span class="line">    <span class="keyword">set</span> num <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> &#123;<span class="variable">$num</span> &lt; <span class="variable">$number</span>&#125; &#123;</span><br><span class="line">        WriteReg <span class="number">0x68</span> <span class="number">0x00</span></span><br><span class="line">        <span class="keyword">incr</span> num <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">    # 选择 0 通道CS</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x00</span></span><br><span class="line"><span class="comment">    # 使能 master, 开始发数据</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x86</span></span><br><span class="line"><span class="comment">    # 选择 0 通道CS 拉高</span></span><br><span class="line">    WriteReg <span class="number">0x70</span> <span class="number">0x1</span></span><br><span class="line"><span class="comment">    # 禁用 master</span></span><br><span class="line">    WriteReg <span class="number">0x60</span> <span class="number">0x186</span></span><br><span class="line"></span><br><span class="line"><span class="comment">    ######################## 写文件 ########################</span></span><br><span class="line">    <span class="keyword">set</span> fn <span class="string">&quot;./rd_data.txt&quot;</span></span><br><span class="line">    <span class="keyword">set</span> fid [<span class="keyword">open</span> <span class="variable">$fn</span> w+]</span><br><span class="line">    <span class="keyword">set</span> num <span class="number">0</span></span><br><span class="line">    <span class="keyword">puts</span> <span class="variable">$fid</span> <span class="string">&quot;Number   Address   Data&quot;</span></span><br><span class="line">    <span class="keyword">while</span> &#123;<span class="variable">$num</span> &lt; <span class="variable">$number</span> + <span class="number">4</span>&#125; &#123;</span><br><span class="line">        <span class="keyword">if</span> &#123;<span class="variable">$num</span> &gt;= <span class="number">4</span>&#125; &#123;</span><br><span class="line">            <span class="keyword">puts</span> <span class="variable">$fid</span> [<span class="keyword">format</span> <span class="string">&quot;%-8d %#0-8x   0x%s&quot;</span> [<span class="keyword">expr</span> &#123;<span class="variable">$num</span><span class="number">-3</span>&#125;] [<span class="keyword">expr</span> &#123;<span class="variable">$address</span> + <span class="variable">$num</span> - <span class="number">3</span>&#125;] [<span class="keyword">string</span> range [ReadReg <span class="number">0x6c</span>] end<span class="number">-1</span> end]]</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            ReadReg <span class="number">0x6c</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">incr</span> num <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">close</span> <span class="variable">$fid</span></span><br><span class="line"><span class="comment">    ######################## 读文件到变量 line ########################</span></span><br><span class="line"><span class="comment">    # 命令eof, 一旦读取到文件末尾, 该命令就返回 1</span></span><br><span class="line">    <span class="keyword">set</span> fid [<span class="keyword">open</span> <span class="variable">$fn</span> r+]</span><br><span class="line">    <span class="keyword">while</span> &#123;[<span class="keyword">eof</span> <span class="variable">$fid</span>] != <span class="number">1</span>&#125; &#123;</span><br><span class="line">        <span class="keyword">gets</span> <span class="variable">$fid</span> line</span><br><span class="line">        <span class="keyword">puts</span> <span class="variable">$line</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">close</span> <span class="variable">$fid</span></span><br><span class="line">    <span class="keyword">puts</span> <span class="string">&quot;Read Done!&quot;</span></span><br><span class="line"><span class="comment">    # set num 0</span></span><br><span class="line"><span class="comment">    # set read_data &quot;ReadData is &quot;</span></span><br><span class="line"><span class="comment">    # while &#123;$num &lt; $number + 4&#125; &#123;</span></span><br><span class="line"><span class="comment">    #     if &#123;$num &gt;= 4&#125; &#123;</span></span><br><span class="line"><span class="comment">    #         append read_data [string range [ReadReg 0x6c] end-1 end]</span></span><br><span class="line"><span class="comment">    #     &#125; else &#123;</span></span><br><span class="line"><span class="comment">    #         ReadReg 0x6c</span></span><br><span class="line"><span class="comment">    #     &#125;</span></span><br><span class="line"><span class="comment">    #     incr num 1</span></span><br><span class="line"><span class="comment">    # &#125;</span></span><br><span class="line"><span class="comment">    # return $read_data</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



 
      <!-- reward -->
      
        <div id="reword-out" style="border-top-width: 20px;padding-top: 30px;">
            <div id="reward-btn" style="
                margin-bottom: 0px;
                margin-top: 0px;
                ">Donate
            </div>
        </div>
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Xilinx-IP/" rel="tag">Xilinx IP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/axi-quad-spi/" rel="tag">axi_quad_spi</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/07/08/Verilog/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Verilog
          
        </div>
      </a>
    
    
      <a href="/2023/07/08/office%E8%BD%AF%E4%BB%B6/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Office</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
        <li style="
            padding-bottom: 0px;
            width: 30px;
            padding-right: 5px;
        ">
        <img src="/images/favicon.ico">
      </li>
      <li>
        &copy;
        2023
        <!-- <i class="ri-heart-fill heart_icon"></i> Arlen -->
        , 
        Arlen
        .
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle">
    <style>
        .navbar-toggle {
            background-color: rgba(0,0,0,.05);
        }
    </style>
</button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer.png" alt="Welcome"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      <a class="nav-item-link" target="_blank" href="https://github.com/hjh0920">
        <i class="ri-github-fill"></i>
        <!-- <i class="ri-github-line"></i> -->
      </a>
    </li>
  </ul>
  <style>
    .navbar .nav .nav-item-link {
        display: block;
        padding: 1rem;
        color: #918888;
        text-decoration: none;
        cursor: pointer;
    }
  </style>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
      <style>
        .sidebar {
          background-color: rgba(0,0,0,.1);
        }
      </style>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: ".tocbot",
    // Where to grab the headings to build the table of contents.
    contentSelector: ".article-entry",
    // Which headings to grab inside of the contentSelector element.
    headingSelector: "h1, h2, h3, h4, h5, h6",
    // For headings inside relative or absolute positioned containers within content.
    hasInnerContainers: true,
    // Smooth scrolling enabled.
    scrollSmooth: true,
    // If there is a fixed article scroll container, set to calculate titles' offset
    scrollContainer: "main",
    // Element to add the positionFixedClass to.
    positionFixedSelector: ".tocbot",
    // Fixed position class to add to make sidebar fixed after scrolling
    // down past the fixedSidebarOffset.
    positionFixedClass: "is-position-fixed",
    // fixedSidebarOffset can be any number but by default is set
    // to auto which sets the fixedSidebarOffset to the sidebar
    // element's offsetTop from the top of the document on init.
    fixedSidebarOffset: "auto",
    // How many heading levels should not be collpased.
    // For example, number 6 will show everything since
    // there are only 6 heading levels and number 0 will collpase them all.
    // The sections that are hidden will open
    // and close as you scroll to headings within them.
    // collapseDepth: "is-collapsed",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>